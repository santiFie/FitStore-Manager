<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Selección de elementos del DOM
        const productList = document.getElementById('product_list');
        const productInput = document.querySelector('input[list="product_list"]');
        const quantityInput = document.querySelector('input[name*="[quantity]"]');
        const subtotalInput = document.querySelector('input[name*="[subtotal]"]');
        const addSaleItemButton = document.querySelector('button.add-item');
        const addedProductsList = document.getElementById('added_products');

        // Función para actualizar subtotal
        function updateSubtotal() {
            const selectedOption = Array.from(productList.options)
                .find(option => option.value === productInput.value);
            
            const unitPrice = selectedOption ? parseFloat(selectedOption.dataset.price) : 0;
            const quantity = parseInt(quantityInput.value) || 0;
            const subtotal = unitPrice * quantity;
            
            subtotalInput.value = subtotal.toFixed(2);
        }

        // Función para actualizar total de la venta
        function updateTotal() {
            const subtotalInputs = document.querySelectorAll('input[name*="[subtotal]"]');
            const totalInput = document.querySelector('input[name="sale[total]"]');
            
            let total = 0;
            subtotalInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            totalInput.value = total.toFixed(2);
        }

        // Agregar eventos para cálculo dinámico de subtotal
        productInput.addEventListener('input', updateSubtotal);
        quantityInput.addEventListener('input', updateSubtotal);

        // Evento para botón de agregar producto
        addSaleItemButton.addEventListener('click', function(event) {
            event.preventDefault();

            // Obtener datos del producto seleccionado
            const selectedOption = Array.from(productList.options)
                .find(option => option.value === productInput.value);
            
            const productId = selectedOption ? selectedOption.getAttribute('data') : null;
            const productName = selectedOption ? selectedOption.text : '';
            const quantity = parseInt(quantityInput.value) || 0;
            const subtotal = parseFloat(subtotalInput.value) || 0;

            // Validar que los datos sean correctos
            if (productName && quantity > 0 && subtotal > 0) {
                // Buscar si el producto ya existe en la lista
                const existingItem = Array.from(addedProductsList.children)
                    .find(li => li.dataset.productId === productId);

                if (existingItem) {
                    // Si el producto ya existe, actualizar cantidad y subtotal
                    const currentQuantity = parseInt(existingItem.dataset.quantity);
                    const currentSubtotal = parseFloat(existingItem.dataset.subtotal);
                    
                    const newQuantity = currentQuantity + quantity;
                    const newSubtotal = currentSubtotal + subtotal;

                    existingItem.textContent = `${productName} - Cantidad: ${newQuantity} - Subtotal: $${newSubtotal.toFixed(2)}`;
                    
                    // Actualizar los data attributes
                    existingItem.dataset.quantity = newQuantity;
                    existingItem.dataset.subtotal = newSubtotal;
                } else {
                    // Si el producto no existe, crear un nuevo elemento
                    const listItem = document.createElement('li');
                    listItem.textContent = `${productName} - Cantidad: ${quantity} - Subtotal: $${subtotal.toFixed(2)}`;
                    
                    // Añadir data attributes para identificación y seguimiento
                    listItem.dataset.productId = productId;
                    listItem.dataset.quantity = quantity;
                    listItem.dataset.subtotal = subtotal;
                    
                    addedProductsList.appendChild(listItem);
                }

                // Resetear valores del formulario
                productInput.value = '';
                quantityInput.value = 1;
                subtotalInput.value = 0;

                // Actualizar total
                updateTotal();

                // Ocultar mensaje de no productos
                const noProductsMessage = document.getElementById('no-products');
                if (noProductsMessage) {
                    noProductsMessage.remove();
                }
            }
        });

        // Actualizar total inicialmente
        updateTotal();
    });
</script>

<%= form_with model: @sale, local: true do |sale_form| %>
    <% if @sale.errors.any? %>
        <div id="error_explanation">
            <ul>
                <% @sale.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                <% end %>
            </ul>
        </div>
    <% end %>

    <h2>Datos del Cliente</h2>
    <%= sale_form.fields_for :client do |client_form| %>
        <div class="field">
            <%= client_form.label :first_name, "Nombre del cliente" %>
            <%= client_form.text_field :first_name %>
        </div>

        <div class="field">
            <%= client_form.label :last_name, "Apellido del cliente" %>
            <%= client_form.text_field :last_name %>
        </div>

        <div class="field">
            <%= client_form.label :email, "Correo electrónico" %>
            <%= client_form.email_field :email %>
        </div>

        <div class="field">
            <%= client_form.label :birth_date, "Fecha de nacimiento" %>
            <%= client_form.date_field :birth_date %>
        </div>
    <% end %>

    <h2>Producto</h2>
    <%= sale_form.fields_for :sale_items do |sale_item_form| %>
        <div class="sale-item-fields">

            <%= sale_item_form.label :product_id, "Producto" %>
            <%= sale_item_form.text_field :product_id, 
                list: "product_list", 
                placeholder: "Selecciona un producto" %>
            
            <datalist id="product_list">
                <% Product.all.each do |product| %>
                    <option data="<%= product.id %>" data-price="<%= product.unit_price %>">
                        <%= product.name %> - $<%= product.unit_price %>
                    </option>
                <% end %>
            </datalist>

            <div class="field">
                <%= sale_item_form.label :quantity, "Cantidad" %>
                <%= sale_item_form.number_field :quantity, min: 1 %>
            </div>

            <div>
                <div class="field">
                    <%= sale_item_form.label :subtotal, "Subtotal" %>
                    <%= sale_item_form.text_field :subtotal, readonly: true, value: 0 %>
                </div>
            </div>

            <div>
                <button type="button" class="add-item">Agregar producto</button>
            </div>

        </div>
    <% end %>

    <h2>Total de la venta</h2>
    <ul id="added_products">
        <% if @sale.sale_items.count > 0 %>
            <% @sale.sale_items.each do |item| %>
                <li data-product-id="<%= item.product_id %>" 
                    data-quantity="<%= item.quantity %>" 
                    data-subtotal="<%= item.subtotal %>">
                    <%= item.product_id ? Product.find(item.product_id).name : 'Producto no encontrado' %> - Cantidad: <%= item.quantity %> - Subtotal: $<%= item.subtotal %>
                </li>
            <% end %>
        <% else %>
            <p class="no-items" id="no-products">No se han agregado productos</p>
        <% end %>
    </ul>

    <div>
        <div class="field">
            <%= sale_form.label :total, "Total" %>
            <%= sale_form.text_field :total, readonly: true, value: 0 %>
        </div>

    </div>

    <div class="field">
        <%= sale_form.label :sale_date, "Fecha de venta" %>
        <%= sale_form.date_field :sale_date %>
    </div>

    <div class="actions">
        <%= sale_form.submit "Guardar Venta" %>
    </div>
<% end %>

<%= link_to "Volver", sales_path %>

<style>

    .product-select {
        width: 100%; /* Ancho completo */
        max-height: 200px; /* Altura máxima */
        overflow-y: auto; /* Scroll vertical cuando sea necesario */
    }

</style>
